input {
  kafka {
    bootstrap_servers => "kafka:9092"
    topics => ["mintstack-logs"]
    group_id => "logstash-consumer"
    codec => json
    consumer_threads => 1
    decorate_events => true
  }
}

filter {
  # Parse JSON log message if needed
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
      skip_on_invalid_json => true
    }
  }

  # Add timestamp if not present
  if ![timestamp] {
    ruby {
      code => "event.set('timestamp', Time.now.utc.iso8601(3))"
    }
  }

  # Extract trace context
  if [parsed][traceId] {
    mutate {
      add_field => { "trace_id" => "%{[parsed][traceId]}" }
    }
  }

  if [parsed][spanId] {
    mutate {
      add_field => { "span_id" => "%{[parsed][spanId]}" }
    }
  }

  # Standardize log levels
  if [parsed][level] {
    mutate {
      add_field => { "log_level" => "%{[parsed][level]}" }
    }
  }

  # Add service metadata
  mutate {
    add_field => { 
      "[@metadata][index_prefix]" => "mintstack-logs"
    }
  }
}

output {
  opensearch {
    hosts => ["http://opensearch:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
    action => "index"
  }
  
  # Debug output (disable in production)
  stdout {
    codec => rubydebug
  }
}
